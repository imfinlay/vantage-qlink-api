<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCP Command Console</title>
    <script>
        async function fetchServers() {
            const res = await fetch('/servers');
            const data = await res.json();
            return Array.isArray(data) ? data : (Array.isArray(data.servers) ? data.servers : []);
        }

        async function fetchCommands() {
            const response = await fetch('/commands');
            return response.json();
        }

        async function fetchLogs() {
            const response = await fetch('/logs');
            return response.json();
        }

        async function connectToServer(serverIndex) {
            const response = await fetch('/connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serverIndex }),
            });
            return response.json();
        }

        async function disconnect() {
            const response = await fetch('/disconnect', { method: 'POST' });
            return response.json();
        }

        async function sendCommand(message) {
            const response = await fetch('/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: message }),
            });
            return response.json();
        }

        async function fetchStatus() {
            const response = await fetch('/status');
            return response.json();
        }

        function populateServers(servers) {
            const select = document.getElementById('server-select');
            select.innerHTML = '';
            servers.forEach((server, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${server.name} (${server.host}:${server.port})`;
                select.appendChild(option);
            });
        }

        async function initialize() {
            try {
                const servers = await fetchServers();
                populateServers(servers);

                const status = await fetchStatus();
                document.getElementById('status').textContent = status.connected
                    ? `Connected to ${status.server?.name || status.server?.host}`
                    : 'Not connected';
            } catch (e) {
                console.error('Initialization error:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', initialize);

        function getSelectedModifier() {
            const radios = document.querySelectorAll('input[name="modifier"]');
            for (const radio of radios) {
                if (radio.checked) return radio.value;
            }
            return '';
        }

        async function onConnectClick() {
            const select = document.getElementById('server-select');
            const index = parseInt(select.value, 10);
            const result = await connectToServer(index);
            document.getElementById('output').textContent = result.message || JSON.stringify(result);
            const status = await fetchStatus();
            document.getElementById('status').textContent = status.connected
                ? `Connected to ${status.server?.name || status.server?.host}`
                : 'Not connected';
        }

        async function onDisconnectClick() {
            const result = await disconnect();
            document.getElementById('output').textContent = result.message || JSON.stringify(result);
            const status = await fetchStatus();
            document.getElementById('status').textContent = status.connected
                ? `Connected to ${status.server?.name || status.server?.host}`
                : 'Not connected';
        }

        async function onSendClick() {
            const input = document.getElementById('command-input');
            const modifier = getSelectedModifier();
            const message = input.value + (modifier || '');
            const result = await sendCommand(message);
            document.getElementById('output').textContent = result.message || JSON.stringify(result);
        }
    </script>
</head>
<body>
    <h1>TCP Command Console</h1>
    <div>
        <label for="server-select">Select Server:</label>
        <select id="server-select"></select>
        <button id="connect-btn" onclick="onConnectClick()">Connect</button>
        <button id="disconnect-btn" onclick="onDisconnectClick()">Disconnect</button>
        <span id="status">Not connected</span>
    </div>

    <div style="margin-top: 1rem;">
        <h3>Send Command</h3>
        <input id="command-input" type="text" placeholder="Enter command" />
        <div>
            <label><input type="radio" name="modifier" value="" checked>None</label>
            <label><input type="radio" name="modifier" value="$">$ (short response)</label>
            <label><input type="radio" name="modifier" value="#"># (detailed response)</label>
        </div>
        <button id="send-btn" onclick="onSendClick()">Send</button>
    </div>

    <div style="margin-top: 1rem;">
        <h3>Output:</h3>
        <pre id="output" style="white-space: pre-wrap; background:#f6f6f6; padding:10px; border:1px solid #ddd;"></pre>
    </div>

    <div style="margin-top: 1rem;">
        <h3>Log:</h3>
        <div id="log-container" style="border: 1px solid #ccc; padding: 10px; max-height: 300px; overflow-y: auto;">(Logs endpoint not wired yet)</div>
    </div>
</body>
</html>

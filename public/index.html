<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Vantage QLink API — Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0f14; --panel:#121822; --muted:#9fb0c3; --text:#e6eef7; --accent:#3aa0ff; --ok:#23d18b; --warn:#ffcc00; --err:#ff4d4d; }
    body { margin:0; font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; background:#0e141d; border-bottom:1px solid #1b2636; position:sticky; top:0; z-index:10; }
    h1 { margin:0; font-size:16px; letter-spacing:.2px; }
    .wrap { display:grid; grid-template-columns: 360px 1fr; gap:12px; padding:12px; }
    .panel { background:var(--panel); border:1px solid #1b2636; border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { color:var(--muted); font-size:12px; }
    select, input[type="text"], input[type="number"] { background:#0e141d; color:var(--text); border:1px solid #1b2636; border-radius:8px; padding:8px; outline:none; }
    button { background:var(--accent); color:#00172a; border:0; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer; }
    button.secondary { background:#1c2736; color:var(--text); }
    button:disabled { opacity:.5; cursor:not-allowed; }
    pre { margin:0; background:#0c121a; border:1px solid #1b2636; border-radius:8px; padding:10px; max-height:40vh; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    table { width:100%; border-collapse:separate; border-spacing:0; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #1b2636; vertical-align:top; }
    th { position:sticky; top:0; background:#111826; z-index:1; }
    .tag { font-size:11px; color:#9fb0c3; border:1px solid #263242; padding:2px 6px; border-radius:999px; }
    .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
    .ok { background:var(--ok); } .err { background:var(--err); } .warn { background:var(--warn); }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .muted { color:var(--muted); }
    .small { font-size:12px; color:var(--muted); }
    .right { text-align:right; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; margin:8px 0; }
    .ghost { opacity:.8; }
  </style>
</head>
<body>
  <header>
    <h1>Vantage QLink API — Console <span id="statusBadge" class="tag">disconnected</span></h1>
  </header>

  <div class="wrap">
    <!-- LEFT: controls -->
    <div class="panel">
      <h3>Connection</h3>
      <div class="row">
        <label for="serverSelect">Server</label>
        <select id="serverSelect"></select>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" class="secondary">Disconnect</button>
      </div>
      <div class="small muted" id="connInfo">—</div>

      <hr style="border:none;border-top:1px solid #1b2636; margin:12px 0;" />

      <h3>Send Command</h3>
      <div class="row" style="gap:6px;">
        <input id="cmdInput" type="text" placeholder="e.g. VQM or VSW 2 20 7 1" style="flex:1;" />
        <button id="sendBtn">Send</button>
      </div>
      <div class="grid2">
        <div>
          <label>quietMs</label>
          <input id="quietMs" type="number" min="0" step="50" value="300" style="width:100%;">
        </div>
        <div>
          <label>maxMs</label>
          <input id="maxMs" type="number" min="100" step="100" value="2000" style="width:100%;">
        </div>
      </div>
      <div class="small muted">Response (last send)</div>
      <pre id="sendResp" style="max-height:18vh;"></pre>
    </div>

    <!-- RIGHT: commands + logs -->
    <div class="panel">
      <div class="grid2">
        <div>
          <h3>Commands</h3>
          <div class="toolbar">
            <input id="cmdFilter" type="text" placeholder="Filter commands..." style="flex:1;">
            <button id="reloadCmds" class="secondary">Reload</button>
          </div>
          <div style="max-height:32vh; overflow:auto;">
            <table id="commandsTable">
              <thead>
                <tr><th style="width:22%">Command</th><th>Description</th><th style="width:24%">Params</th></tr>
              </thead>
              <tbody id="commandsBody"></tbody>
            </table>
          </div>
          <div class="small muted">Tip: click any command to paste it into the input.</div>
        </div>

        <div>
          <h3>Logs <span id="logCount" class="muted small"></span></h3>
          <div class="toolbar">
            <div class="row">
              <label for="logLimit">lines</label>
              <input id="logLimit" type="number" min="50" max="2000" step="50" value="300" style="width:90px;">
              <label class="row" style="gap:6px;"><input id="autoScroll" type="checkbox" checked> Auto-scroll</label>
            </div>
            <div class="row">
              <button id="refreshLogs" class="secondary">Refresh</button>
              <button id="toggleLogs" class="secondary">Pause</button>
            </div>
          </div>
          <pre id="logBox"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const statusBadge = $('statusBadge');
  const connInfo = $('connInfo');
  const serverSelect = $('serverSelect');
  const sendResp = $('sendResp');
  const logBox = $('logBox');
  const logCount = $('logCount');

  async function api(path, opts = {}) {
    const res = await fetch(path, opts);
    if (!res.ok) {
      const text = await res.text().catch(()=>'');
      throw new Error(`${res.status} ${res.statusText} — ${text}`);
    }
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) return res.json();
    return res.text();
  }

  function setConnected(connected, server) {
    statusBadge.textContent = connected ? 'connected' : 'disconnected';
    statusBadge.className = 'tag ' + (connected ? '' : 'ghost');
    if (connected && server) connInfo.textContent = `${server.name || ''} ${server.host}:${server.port}`;
    else connInfo.textContent = '—';
  }

  function showError(e) {
    console.error(e);
    sendResp.textContent = String(e && e.message || e);
  }

  // ---------- Servers ----------
  async function loadServers() {
    try {
      const data = await api('/servers');
      const list = (data && data.servers) || [];
      serverSelect.innerHTML = '';
      if (!list.length) {
        const opt = document.createElement('option');
        opt.text = 'No servers configured';
        opt.value = '';
        serverSelect.appendChild(opt);
        return;
      }
      list.forEach(s => {
        const opt = document.createElement('option');
        opt.value = String(s.index);
        opt.text = `${s.name || 'Server'} — ${s.host}:${s.port}`;
        serverSelect.appendChild(opt);
      });
    } catch (e) {
      showError(e);
    }
  }

  async function connect() {
    try {
      const idx = parseInt(serverSelect.value, 10);
      if (!Number.isFinite(idx)) throw new Error('Select a server');
      const r = await api('/connect', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ serverIndex: idx })
      });
      await refreshStatus();
      sendResp.textContent = r && r.message ? r.message : 'Connected';
    } catch (e) { showError(e); }
  }

  async function disconnect() {
    try {
      const r = await api('/disconnect', { method:'POST' });
      await refreshStatus();
      sendResp.textContent = r && r.message ? r.message : 'Disconnected';
    } catch (e) { showError(e); }
  }

  async function refreshStatus() {
    try {
      const s = await api('/status');
      setConnected(!!(s && s.connected), s && s.server);
    } catch (e) {
      setConnected(false);
      console.warn('status failed', e);
    }
  }

  // ---------- Commands list ----------
  function renderCommands(items) {
    const body = $('commandsBody');
    const filter = ($('cmdFilter').value || '').toLowerCase();
    body.innerHTML = '';
    const rows = items
      .filter(it => {
        if (!filter) return true;
        return (
          (it.command || '').toLowerCase().includes(filter) ||
          (it.description || '').toLowerCase().includes(filter) ||
          (it.params || '').toLowerCase().includes(filter)
        );
      })
      .map(it => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><code>${escapeHtml(it.command || '')}</code></td>
          <td>${escapeHtml(it.description || '')}</td>
          <td class="small muted">${escapeHtml(it.params || '')}</td>
        `;
        tr.addEventListener('click', () => {
          const input = $('cmdInput');
          input.value = it.command || '';
          input.focus();
        });
        return tr;
      });
    rows.forEach(tr => body.appendChild(tr));
  }

  async function loadCommands() {
    try {
      const data = await api('/commands');
      const items = (data && Array.isArray(data.items) && data.items.length) ?
        data.items :
        ((data && Array.isArray(data.commands)) ? data.commands.map(c => ({ command:c, description:'', params:'' })) : []);
      renderCommands(items);
    } catch (e) { showError(e); }
  }

  // ---------- Send ----------
  async function sendCmd() {
    try {
      const cmd = $('cmdInput').value.trim();
      if (!cmd) throw new Error('Enter a command');
      const quietMs = Math.max(0, parseInt($('quietMs').value,10) || 0);
      const maxMs   = Math.max(100, parseInt($('maxMs').value,10) || 2000);

      const r = await api('/send', {
        method:'POST',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ command: cmd, quietMs, maxMs })
      });
      sendResp.textContent = JSON.stringify(r, null, 2);
    } catch (e) { showError(e); }
  }

  // ---------- Logs ----------
  let logTimer = null;
  let logsPaused = false;

  async function fetchLogs(limit) {
    const data = await api(`/logs?limit=${encodeURIComponent(limit)}`);
    return (data && Array.isArray(data.lines)) ? data.lines : [];
  }

  async function refreshLogsOnce() {
    try {
      const limit = Math.min(Math.max(parseInt($('logLimit').value,10) || 300, 50), 2000);
      const lines = await fetchLogs(limit);
      logBox.textContent = lines.join('\n');
      logCount.textContent = `(${lines.length} lines)`;
      if ($('autoScroll').checked) logBox.scrollTop = logBox.scrollHeight;
    } catch (e) {
      console.warn('logs error', e);
    }
  }

  function startLogs() {
    if (logTimer) return;
    logsPaused = false;
    refreshLogsOnce();
    logTimer = setInterval(refreshLogsOnce, 1500);
    $('toggleLogs').textContent = 'Pause';
  }
  function stopLogs() {
    logsPaused = true;
    if (logTimer) { clearInterval(logTimer); logTimer = null; }
    $('toggleLogs').textContent = 'Resume';
  }

  // ---------- Utils ----------
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  // ---------- Wire up ----------
  window.addEventListener('DOMContentLoaded', async () => {
    $('connectBtn').addEventListener('click', connect);
    $('disconnectBtn').addEventListener('click', disconnect);
    $('sendBtn').addEventListener('click', sendCmd);
    $('reloadCmds').addEventListener('click', loadCommands);
    $('cmdFilter').addEventListener('input', loadCommands);
    $('refreshLogs').addEventListener('click', refreshLogsOnce);
    $('toggleLogs').addEventListener('click', () => (logTimer ? stopLogs() : startLogs()));

    await loadServers();
    await refreshStatus();
    await loadCommands();
    startLogs();
  });
})();
</script>
</body>
</html>
